build:
  name: Build and notarize Orbit
  steps:
    - eas/checkout
    - configure_macos_credentials:
        inputs:
          buildCredentials: ${ eas.job.secrets.buildCredentials }
    - eas/install_node_modules
    - run:
        name: Build packages
        working_directory: ../../
        command: |
          yarn build
    - run:
        name: Archive CLI
        working_directory: ../../apps/cli
        command: |
          yarn archive
    - run:
        name: Codesign CLI
        working_directory: ../../apps/cli
        command: |
          yarn codesign
    - run:
        name: Install menu-bar pods
        working_directory: ./macos
        command: pod install
    - run:
        name: Archive menu-bar
        working_directory: ../../apps/menu-bar
        command: |
          yarn archive
    - run:
        name: Export archive menu-bar
        working_directory: ../../apps/menu-bar
        command: |
          yarn export-local-archive
    - run:
        name: codesign menu-bar
        working_directory: ../../apps/menu-bar
        command: |
          codesign --force -s "Developer ID Application: 650 Industries, Inc. (C8D8QTF339)" -v build/Release/Expo\ Orbit.app --deep --strict --options=runtime --timestamp
    - run:
        name: zip menu-bar export
        working_directory: ../../apps/menu-bar
        command: |
          zip -r build/Release/ExpoOrbit.zip build/Release/Expo\ Orbit.app
    - eas/find_and_upload_build_artifacts
    - run:
        name: Notarize menu-bar
        working_directory: ../../apps/menu-bar
        command: |
          xcrun notarytool submit "build/Release/ExpoOrbit.zip" --apple-id $APPLE_ID_NOTARIZATION_EMAIL --password $APPLE_ID_NOTARIZATION_PASSWORD  --team-id "C8D8QTF339" --wait
functions:
  configure_macos_credentials:
    name: Configure macOS Credentials
    inputs:
      - name: buildCredentials
        type: json
    path: ./configureMacOSCredentials
